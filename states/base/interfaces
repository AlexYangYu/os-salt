{% set host = salt['config.get']('host') %}
{% set interfaces =  salt['pillar.get']('nodes:' + host + ':interfaces') %}
{% set external_interface = salt['pillar.get']('network:external_interface') %}

auto lo
iface lo inet loopback

{% for interface in interfaces %}

{% if interface == external_interface %}

auto {{ interface }}
iface {{ interface }} inet manual
    up ifconfig $IFACE 0.0.0.0 up
    up ip link set $IFACE promisc on
    post-up ethtool -K $IFACE tso off lro off gro off gso off
    down ip link set $IFACE promisc off
    down ifconfig $IFACE down

{% else %}

{% set addr = salt['pillar.get']('nodes:' + host + ':interfaces:' + interface + ':addr') %}
{% set netmask = salt['pillar.get']('nodes:' + host + ':interfaces:' + interface + ':netmask') %}
{% set gateway = salt['pillar.get']('nodes:' + host + ':interfaces:' + interface + ':gateway') %}
{% set dns_nameservers = salt['pillar.get']('nodes:' + host + ':interfaces:' + interface + ':dns_nameservers') %}
{% set dns_search = salt['pillar.get']('nodes:' + host + ':interfaces:' + interface + ':dns_search') %}
auto {{ interface }}
iface {{ interface }} inet static
    address {{ addr }}
    netmask {{ netmask }}
    {% if gateway %}
    gateway {{ gateway }}
    {% endif %}
    {% if dns_nameservers %}
    dns-nameservers {{ dns_nameservers }}
    {% endif %}
    {% if dns_search %}
    dns-search {{ dns_search }}
    {% endif %}

{% endif %}

{% endfor %}
